# =============================================================================
# Docker Compose for Nemotron 49B LLM Service on GX10 (DGX Spark)
# Optimized for Grace Blackwell GB10 with 128GB unified memory
# =============================================================================
#
# Usage:
#   docker compose -f docker-compose.nemotron.yml up nemotron-llm   # Start LLM server
#   docker compose -f docker-compose.nemotron.yml up -d             # Start all services
#
# Test the API:
#   curl http://localhost:5000/v1/models
#   curl http://localhost:5000/v1/chat/completions \
#     -H "Content-Type: application/json" \
#     -d '{"model": "nemotron-49b", "messages": [{"role": "user", "content": "Hello!"}]}'
# =============================================================================

services:
  # Nemotron 49B LLM Server via vLLM
  nemotron-llm:
    image: vllm/vllm-openai:v0.9.2
    container_name: nemotron-49b-server
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - VLLM_LOGGING_LEVEL=INFO
      # GX10 optimizations for Grace Blackwell unified memory
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    volumes:
      # Mount the local model directory
      - "/home/asus/Desktop/Nemotron 49B:/model:ro"
      # Cache for tokenizers etc
      - nemotron-cache:/root/.cache
    ports:
      - "5000:5000"
    command: >
      --model /model
      --trust-remote-code
      --host 0.0.0.0
      --port 5000
      --served-model-name nemotron-49b
      --tensor-parallel-size 1
      --max-model-len 32768
      --gpu-memory-utilization 0.90
      --enforce-eager
      --dtype bfloat16
      --enable-auto-tool-choice
      --tool-parser-plugin /model/llama_nemotron_toolcall_parser_no_streaming.py
      --tool-call-parser llama_nemotron_json
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped

volumes:
  nemotron-cache:

